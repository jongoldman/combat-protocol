<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Combat Protocol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* VERSION BANNER - Shows for 2 seconds on page load */
        #version-banner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 48px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 4px solid #fff;
            text-align: center;
            animation: fadeOut 2s ease-in-out forwards;
        }

        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; visibility: hidden; }
        }

        #version-banner .version-label {
            font-size: 20px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;  /* Increased for 3D viewport */
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0 30px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #dc2626, #ea580c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .subtitle {
            color: #666;
            font-size: 0.9rem;
        }

        /* Fighter Selection */
        .fighter-select {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .fighter-slot {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .fighter-slot.red { border-color: #ef4444; }
        .fighter-slot.blue { border-color: #3b82f6; }

        .fighter-slot h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
            color: #666;
        }

        .fighter-slot.red h3 { color: #dc2626; }
        .fighter-slot.blue h3 { color: #2563eb; }

        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            color: #333;
            font-size: 1rem;
            cursor: pointer;
        }

        /* 3D PREVIEW SECTION */
        .preview-3d-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            margin: 30px 0;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .preview-3d-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #fff;
        }

        .preview-3d-header h2 {
            font-size: 1.3rem;
            color: #00ff88;
        }

        .preview-toggle-btn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .preview-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        #canvas-container {
            width: 100%;
            height: 500px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #0a0a0f;
        }

        #canvas-container.hidden {
            display: none;
        }

        .fighter-3d-labels {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            pointer-events: none;
            z-index: 10;
        }

        .fighter-3d-label {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid;
            font-weight: bold;
            color: #fff;
        }

        .fighter-3d-label.red { border-color: #ef4444; }
        .fighter-3d-label.blue { border-color: #3b82f6; }

        .preview-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .preview-control-btn {
            background: #00ff88;
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .preview-control-btn:hover {
            background: #00cc6a;
            transform: translateY(-1px);
        }

        .preview-control-btn:active {
            transform: translateY(0);
        }

        /* Create Fighter Button */
        .create-fighter-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 0.85rem;
            background: transparent;
            border: 2px dashed #ddd;
            border-radius: 6px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-fighter-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        /* Rest of your existing styles... */
        .fight-btn {
            display: block;
            width: 200px;
            margin: 30px auto;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(90deg, #dc2626, #ea580c);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
            transition: all 0.2s;
        }

        .fight-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
        }

        .fight-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #333;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 1rem;
            resize: vertical;
        }

        .fighter-progress {
            margin: 20px 0;
        }

        .progress-step {
            padding: 12px;
            margin: 8px 0;
            background: #f5f5f5;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-step.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .progress-step.complete {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .progress-icon {
            font-size: 1.2rem;
        }

        .fighter-preview {
            margin: 20px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .fighter-preview h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3rem;
        }

        .preview-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preview-stats div {
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn.cancel:hover {
            background: #d1d5db;
        }

        .modal-btn.generate {
            background: #3b82f6;
            color: white;
        }

        .modal-btn.generate:hover {
            background: #2563eb;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Trash Talk */
        .trash-talk {
            display: none;
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .trash-talk.active {
            display: block;
        }

        .trash-talk h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .quote {
            margin: 15px 0;
            padding: 15px 20px;
            border-radius: 8px;
            position: relative;
        }

        .quote.red {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
        }

        .quote.blue {
            background: #dbeafe;
            border-left: 4px solid #2563eb;
        }

        .quote-name {
            font-weight: bold;
            margin-bottom: 8px;
        }

        .quote.red .quote-name {
            color: #991b1b;
        }

        .quote.blue .quote-name {
            color: #1e40af;
        }

        /* Arena */
        .arena {
            display: none;
            background: #fff;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .arena.active {
            display: block;
        }

        .round-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 15px 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .round-num {
            font-size: 1.2rem;
            font-weight: bold;
            color: #dc2626;
        }

        .time {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: monospace;
            color: #333;
        }

        .fighters-display {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }

        .fighter-panel {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            background: #f9fafb;
        }

        .fighter-panel.left {
            border-left: 4px solid #dc2626;
        }

        .fighter-panel.right {
            border-left: 4px solid #2563eb;
        }

        .fighter-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .fighter-panel.left .fighter-name {
            color: #dc2626;
        }

        .fighter-panel.right .fighter-name {
            color: #2563eb;
        }

        .stat-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .stat-label {
            min-width: 80px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #666;
        }

        .stat-bar {
            flex: 1;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .stat-fill.health {
            background: linear-gradient(90deg, #ef4444, #dc2626);
        }

        .stat-fill.stamina {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .action-log {
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.round-start {
            font-weight: bold;
            color: #dc2626;
            padding: 12px 0;
        }

        .log-entry.strike {
            color: #ea580c;
        }

        .log-entry.miss {
            color: #64748b;
        }

        .log-entry.critical {
            color: #dc2626;
            font-weight: bold;
        }

        .result {
            text-align: center;
            padding: 30px;
            margin-top: 30px;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
        }

        .result h2 {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #92400e;
        }

        .result p {
            font-size: 1.1rem;
            color: #78350f;
        }

        @media (max-width: 768px) {
            .fighters-display {
                flex-direction: column;
            }

            h1 {
                font-size: 2rem;
            }

            .fighter-select {
                flex-direction: column;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- VERSION BANNER - Auto-hides after 2 seconds -->
    <div id="version-banner">
        <div class="version-label">Combat Protocol</div>
        <div>v 0.2.9</div>
    </div>

    <div class="container">
        <header>
            <h1>‚öîÔ∏è COMBAT PROTOCOL <sup style="font-size: 0.4em; color: #999; font-weight: 400;">v 0.2.9</sup></h1>
            <p class="subtitle">Physics-Based Fighting Simulation</p>
        </header>

        <!-- Fighter Selection -->
        <div class="fighter-select">
            <div class="fighter-slot red">
                <h3>RED CORNER</h3>
                <select id="fighter-a">
                    <option value="">Select Fighter...</option>
                </select>
                <button class="create-fighter-btn" data-corner="a">+ Create Custom Fighter</button>
            </div>
            <div class="fighter-slot blue">
                <h3>BLUE CORNER</h3>
                <select id="fighter-b">
                    <option value="">Select Fighter...</option>
                </select>
                <button class="create-fighter-btn" data-corner="b">+ Create Custom Fighter</button>
            </div>
        </div>

        <!-- 3D PREVIEW SECTION -->
        <div class="preview-3d-container" id="preview-3d-section">
            <div class="preview-3d-header">
                <h2>ü•ä Fighter Preview</h2>
                <button class="preview-toggle-btn" id="toggle-3d">Hide 3D View</button>
            </div>
            <div id="canvas-container">
                <div class="fighter-3d-labels">
                    <div class="fighter-3d-label red" id="label-fighter-a">Select Red Corner</div>
                    <div class="fighter-3d-label blue" id="label-fighter-b">Select Blue Corner</div>
                </div>
            </div>
            <div class="preview-controls">
                <button class="preview-control-btn" id="preview-play">‚ñ∂Ô∏è Play</button>
                <button class="preview-control-btn" id="preview-pause">‚è∏Ô∏è Pause</button>
                <button class="preview-control-btn" id="preview-reset">üîÑ Reset Camera</button>
            </div>
        </div>

        <!-- Fight Button -->
        <button class="fight-btn" id="fight-btn" disabled>FIGHT!</button>

        <!-- Create Fighter Modal -->
        <div class="modal-overlay" id="create-fighter-modal">
            <div class="modal">
                <h2>Create Custom Fighter</h2>
                <p style="margin-bottom: 15px; color: #666;">Describe your fighter and we'll generate their stats and appearance.</p>
                
                <textarea id="fighter-description" placeholder="Example: A massive heavyweight from Brazil with incredible power and an aggressive fighting style..."></textarea>
                
                <div class="fighter-progress" id="fighter-progress" style="display: none;">
                    <div class="progress-step" id="progress-validate">
                        <span class="progress-icon">‚è≥</span> Validating description...
                    </div>
                    <div class="progress-step" id="progress-stats">
                        <span class="progress-icon">‚è≥</span> Generating stats...
                    </div>
                    <div class="progress-step" id="progress-image">
                        <span class="progress-icon">‚è≥</span> Creating image...
                    </div>
                </div>

                <div class="fighter-preview" id="fighter-preview" style="display: none;">
                    <h3 id="preview-name"></h3>
                    <div class="preview-stats">
                        <div><strong>Height:</strong> <span id="preview-height"></span>cm</div>
                        <div><strong>Weight:</strong> <span id="preview-weight"></span>kg</div>
                        <div><strong>Age:</strong> <span id="preview-age"></span></div>
                        <div><strong>Power:</strong> <span id="preview-power"></span></div>
                        <div><strong>Speed:</strong> <span id="preview-speed"></span></div>
                        <div><strong>Cardio:</strong> <span id="preview-cardio"></span></div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="cancel-create">Cancel</button>
                    <button class="modal-btn generate" id="generate-fighter">Generate Fighter</button>
                </div>
            </div>
        </div>

        <!-- Trash Talk -->
        <div class="trash-talk" id="trash-talk">
            <h2>üé§ Trash Talk</h2>
            <div class="quote red">
                <div class="quote-name" id="quote-name-a"></div>
                <div id="quote-text-a"></div>
            </div>
            <div class="quote blue">
                <div class="quote-name" id="quote-name-b"></div>
                <div id="quote-text-b"></div>
            </div>
        </div>

        <!-- Arena -->
        <div class="arena" id="arena">
            <div class="round-info">
                <div class="round-num">ROUND <span id="round-num">1</span></div>
                <div class="time" id="time">3:00</div>
            </div>

            <div class="fighters-display">
                <div class="fighter-panel left">
                    <div class="fighter-name" id="display-name-a">Fighter A</div>
                    <div class="stat-row">
                        <span class="stat-label">HP</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="health-a" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Stamina</span>
                        <div class="stat-bar">
                            <div class="stat-fill stamina" id="stamina-a" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Head</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="head-a" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Body</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="body-a" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Legs</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="legs-a" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <div class="fighter-panel right">
                    <div class="fighter-name" id="display-name-b">Fighter B</div>
                    <div class="stat-row">
                        <span class="stat-label">HP</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="health-b" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Stamina</span>
                        <div class="stat-bar">
                            <div class="stat-fill stamina" id="stamina-b" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Head</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="head-b" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Body</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="body-b" style="width: 100%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Legs</span>
                        <div class="stat-bar">
                            <div class="stat-fill health" id="legs-b" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-log" id="action-log"></div>

            <div class="result" id="result" style="display: none;">
                <h2 id="result-title"></h2>
                <p id="result-message"></p>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // =====================================================
        // SOUND EFFECTS
        // =====================================================
        const sounds = {
            fistBump: new Audio('/static/sounds/fist_bump.mp3')
        };
        
        // Preload sounds
        for (let key in sounds) {
            sounds[key].load();
        }
        
        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;  // Reset to start
                sounds[soundName].play().catch(err => {
                    console.log('Sound play failed (user interaction required):', err);
                });
            }
        }        

        // =====================================================
        // 3D SCENE SETUP
        // =====================================================
        const canvasContainer = document.getElementById('canvas-container');
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0f);
        scene.fog = new THREE.Fog(0x0a0a0f, 15, 40);

        const camera = new THREE.PerspectiveCamera(
            45,  // Same FOV as model_test
            canvasContainer.clientWidth / canvasContainer.clientHeight,
            0.1,
            1000
        );
        camera.position.set(0, 1.5, 25);  // Farther back to see both fighters

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        canvasContainer.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 5;
        controls.maxDistance = 50;
        controls.target.set(0, 1, 0);

        // DEBUG the mouse zoom
        controls.minDistance = 20;
        controls.maxDistance = 28;


        // NEW: Slow down zoom speed
        controls.zoomSpeed = 0.0001;  // Default is 1.0, lower = slower
        controls.panSpeed = 0.0001;   // Also slow down panning        

        console.log("---------------------------> Completely disable zoom TBD for debugging")
        console.log("---------------------------> I sure HOPE this console.log message is in the run-time!")

        controls.enableZoom = false;  // Completely disable zoom TBD for debugging

        // ADD THIS for debugging:
        window.controls = controls;  // Make it globally accessible        

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 10, 5);
        directionalLight.castShadow = true;
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        scene.add(directionalLight);

        const fillLight = new THREE.DirectionalLight(0x4444ff, 0.3);
        fillLight.position.set(-5, 5, -5);
        scene.add(fillLight);

        // Ground
        const groundGeometry = new THREE.PlaneGeometry(30, 30);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x0a0a0f,
            roughness: 0.8,
            metalness: 0.2
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Grid
        const gridHelper = new THREE.GridHelper(30, 30, 0x00ff88, 0x003322);
        gridHelper.position.y = 0.01;
        scene.add(gridHelper);

        // Fighter models
        let mixerA = null, mixerB = null;
        let modelA = null, modelB = null;
        let actionA = null, actionB = null;
        
        // Store model centering offsets (CRITICAL for collision detection fix)
        let modelA_offset_x = 0;
        let modelA_offset_z = 0;
        let modelB_offset_x = 0;
        let modelB_offset_z = 0;

        const loader = new GLTFLoader();
        const modelPathA = '/static/models/Punching_blender.glb';  // Fighter A: Punching
        const modelPathB = '/static/models/Boxing_with_kick.glb';  // Fighter B: Boxing with kick

        // Load Fighter A independently
        loader.load(modelPathA, (gltf) => {
            modelA = gltf.scene;
            console.log('Fighter A loaded');
            
            const box = new THREE.Box3().setFromObject(modelA);
            const size = box.getSize(new THREE.Vector3());
            const scaleFactor = 1.8 / size.y;
            
            modelA.scale.set(scaleFactor, scaleFactor, scaleFactor);
            box.setFromObject(modelA);
            const newCenter = box.getCenter(new THREE.Vector3());
            
            // CRITICAL FIX: Store the centering offsets
            modelA_offset_x = -newCenter.x;
            modelA_offset_z = -newCenter.z;
            
            console.log('üî¥ Fighter A OFFSETS:', {
                newCenter_x: newCenter.x,
                newCenter_z: newCenter.z,
                offset_x: modelA_offset_x,
                offset_z: modelA_offset_z
            });
            
            modelA.position.x = modelA_offset_x - 4;  // Left side
            modelA.position.y = -box.min.y;
            modelA.position.z = modelA_offset_z;
            modelA.rotation.y = Math.PI / 2;   // Face +X (toward Fighter B)
            
            console.log('üî¥ Fighter A INITIAL POSITION:', {
                x: modelA.position.x,
                y: modelA.position.y,
                z: modelA.position.z
            });
            
            // Color it Anthropic orange
            modelA.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    node.material.color.set(0xFF6B35);  // Anthropic orange
                }
            });
            
            scene.add(modelA);
            
            if (gltf.animations && gltf.animations.length > 0) {
                mixerA = new THREE.AnimationMixer(modelA);
                actionA = mixerA.clipAction(gltf.animations[0]);
                actionA.setLoop(THREE.LoopRepeat);
                //console.log("-----> actionA.play() is commented out ")
                actionA.play();
            }
        });

        // Load Fighter B independently - OpenAI teal
        loader.load(modelPathB, (gltf) => {
            modelB = gltf.scene;  // Don't clone - use fresh scene
            console.log('Fighter B loaded');
            
            const box = new THREE.Box3().setFromObject(modelB);
            const size = box.getSize(new THREE.Vector3());
            const scaleFactor = 1.8 / size.y;
            
            modelB.scale.set(scaleFactor, scaleFactor, scaleFactor);
            box.setFromObject(modelB);
            const newCenter = box.getCenter(new THREE.Vector3());
            
            // CRITICAL FIX: Store the centering offsets
            modelB_offset_x = -newCenter.x;
            modelB_offset_z = -newCenter.z;
            
            console.log('üîµ Fighter B OFFSETS:', {
                newCenter_x: newCenter.x,
                newCenter_z: newCenter.z,
                offset_x: modelB_offset_x,
                offset_z: modelB_offset_z
            });
            
            modelB.position.x = modelB_offset_x + 4;  // Right side
            modelB.position.y = -box.min.y;
            modelB.position.z = modelB_offset_z;
            
            modelB.rotation.y = -Math.PI / 2;  // Face -X (toward Fighter A)
            
            console.log('üîµ Fighter B INITIAL POSITION:', {
                x: modelB.position.x,
                y: modelB.position.y,
                z: modelB.position.z
            });
            
            // Color it OpenAI teal
            modelB.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    node.material.color.set(0x10A37F);  // OpenAI teal
                }
            });
            
            scene.add(modelB);
            
            if (gltf.animations && gltf.animations.length > 0) {
                mixerB = new THREE.AnimationMixer(modelB);
                actionB = mixerB.clipAction(gltf.animations[0]);
                actionB.setLoop(THREE.LoopRepeat);
                //console.log("-----> actionB.play() is commented out ")
                actionB.play();
            }
        });

        // Animation loop
        const clock = new THREE.Clock();
        function animate() {
            //console.log("ANIMATE RUNNING");  // Add this as first line

            requestAnimationFrame(animate);

            // Force camera to stay in range
            camera.position.z = Math.max(15, Math.min(35, camera.position.z));            

            //console.log("camera.position.z == " + camera.position.z)

            // ADD THIS:
            //console.log('MY Zoom speed:', controls.zoomSpeed);
                

            const delta = clock.getDelta();
            
            if (mixerA) mixerA.update(delta);
            if (mixerB) mixerB.update(delta);
            
            controls.update();
            renderer.render(scene, camera);
        }
        console.log("---------------------> CALLING animate()")
        animate();

        // 3D Preview Controls
        document.getElementById('preview-play').addEventListener('click', () => {
            if (actionA) actionA.paused = false;
            if (actionB) actionB.paused = false;
        });

        document.getElementById('preview-pause').addEventListener('click', () => {
            if (actionA) actionA.paused = true;
            if (actionB) actionB.paused = true;
        });

        document.getElementById('preview-reset').addEventListener('click', () => {
            camera.position.set(0, 1.5, 25);
            controls.target.set(0, 1, 0);
            controls.update();
        });

        // Toggle 3D view
        let is3DVisible = true;
        document.getElementById('toggle-3d').addEventListener('click', () => {
            is3DVisible = !is3DVisible;
            canvasContainer.classList.toggle('hidden');
            document.getElementById('toggle-3d').textContent = is3DVisible ? 'Hide 3D View' : 'Show 3D View';
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        });

        // =====================================================
        // REST OF YOUR EXISTING JAVASCRIPT
        // (Fighter selection, fight simulation, etc.)
        // =====================================================
        
        // Update fighter labels when selections change
        const fighterASelect = document.getElementById('fighter-a');
        const fighterBSelect = document.getElementById('fighter-b');
        
        fighterASelect.addEventListener('change', (e) => {
            const label = document.getElementById('label-fighter-a');
            label.textContent = e.target.options[e.target.selectedIndex].text || 'Select Red Corner';
        });
        
        fighterBSelect.addEventListener('change', (e) => {
            const label = document.getElementById('label-fighter-b');
            label.textContent = e.target.options[e.target.selectedIndex].text || 'Select Blue Corner';
        });

        // Load fighters from API
        async function loadFighters() {
            try {
                const response = await fetch('/api/fighters');
                const fighters = await response.json();
                
                fighters.forEach(fighter => {
                    const optionA = document.createElement('option');
                    optionA.value = fighter.id;
                    optionA.textContent = fighter.name;
                    fighterASelect.appendChild(optionA);
                    
                    const optionB = document.createElement('option');
                    optionB.value = fighter.id;
                    optionB.textContent = fighter.name;
                    fighterBSelect.appendChild(optionB);
                });
            } catch (error) {
                console.error('Error loading fighters:', error);
            }
        }

        // Enable fight button when both fighters selected
        function checkFightReady() {
            const fightBtn = document.getElementById('fight-btn');
            const ready = fighterASelect.value && fighterBSelect.value && 
                          fighterASelect.value !== fighterBSelect.value;
            fightBtn.disabled = !ready;
        }

        fighterASelect.addEventListener('change', checkFightReady);
        fighterBSelect.addEventListener('change', checkFightReady);

        // Start fight
        document.getElementById('fight-btn').addEventListener('click', startFight);

        async function startFight() {
            const fighterA = fighterASelect.value;
            const fighterB = fighterBSelect.value;
            
            if (!fighterA || !fighterB || fighterA === fighterB) return;

            // KEEP 3D view visible to see collision detection!
            // document.getElementById('preview-3d-section').style.display = 'none';

    
            // NEW: Reset fist-bump flag
            window.fistBumpSoundPlayed = false;


            // NEW: Reset fist-bump flag
            window.fistBumpSoundPlayed = false;
            
            // Get fighter data for display
            const [dataA, dataB] = await Promise.all([
                fetch(`/api/fighter/${fighterA}`).then(r => r.json()),
                fetch(`/api/fighter/${fighterB}`).then(r => r.json())
            ]);

            // Show trash talk
            document.getElementById('trash-talk').classList.add('active');
            document.getElementById('quote-name-a').textContent = dataA.name;
            document.getElementById('quote-name-b').textContent = dataB.name;
            document.getElementById('quote-text-a').textContent = '"' + (dataA.trash_talk || 'Ready to fight!') + '"';
            document.getElementById('quote-text-b').textContent = '"' + (dataB.trash_talk || 'Bring it on!') + '"';

            // Show arena
            document.getElementById('arena').classList.add('active');
            document.getElementById('display-name-a').textContent = dataA.name;
            document.getElementById('display-name-b').textContent = dataB.name;

            // Clear action log
            const actionLog = document.getElementById('action-log');
            actionLog.innerHTML = '';

            // Start SSE stream
            const eventSource = new EventSource(`/api/simulate/${fighterA}/${fighterB}`);

            eventSource.addEventListener('round_start', (e) => {
                const data = JSON.parse(e.data);
                console.log('ü•äü•äü•ä ===============================================');
                console.log('ü•äü•äü•ä ROUND ' + data.round + ' STARTING - COMBAT BEGINS!');
                console.log('ü•äü•äü•ä ===============================================');
                document.getElementById('round-num').textContent = data.round;
                actionLog.innerHTML += `<div class="log-entry round-start">ROUND ${data.round} - FIGHT!</div>`;
                actionLog.scrollTop = actionLog.scrollHeight;
            });

            // =====================================================
            // STATE UPDATE - HANDLE POSITION UPDATES (NEW IN v 0.2.9)
            // =====================================================
            eventSource.addEventListener('state_update', (e) => {
                const data = JSON.parse(e.data);
                
                console.log('üìç STATE_UPDATE received:', {
                    modelA: !!modelA,
                    modelB: !!modelB,
                    pos_a_x: data.fighter_a_pos_x,
                    pos_b_x: data.fighter_b_pos_x
                });

                // NEW: Detect fist-bump moment (round 0, fighters close together)
                if (data.round_num === 0 && modelA && modelB) {
                    const distance = Math.abs(data.fighter_a_pos_x - data.fighter_b_pos_x);
                    
                    // If fighters are ~1.0m apart (fist-bump distance)
                    if (distance < 1.2 && distance > 0.8) {
                        // Check if this is first time at bump distance
                        if (!window.fistBumpSoundPlayed) {
                            playSound('fistBump');
                            window.fistBumpSoundPlayed = true;
                            
                            // Optional: Add visual effect
                            console.log('ü§úü§õ FIST BUMP!');
                        }
                    }
                }

                
                // Update fighter positions if they exist in the data
                if (data.fighter_a_pos_x !== undefined && modelA) {
                    // CRITICAL FIX: Apply model centering offset
                    const old_x = modelA.position.x;
                    modelA.position.x = data.fighter_a_pos_x + modelA_offset_x;
                    modelA.position.z = data.fighter_a_pos_z + modelA_offset_z;
                    console.log('üî¥ Updated Fighter A:', {
                        round: data.round_num,
                        sim_x: data.fighter_a_pos_x,
                        sim_z: data.fighter_a_pos_z,
                        offset_x: modelA_offset_x,
                        offset_z: modelA_offset_z,
                        old_actual_x: old_x,
                        new_actual_x: modelA.position.x,
                        new_actual_z: modelA.position.z
                    });
                }
                
                if (data.fighter_b_pos_x !== undefined && modelB) {
                    // CRITICAL FIX: Apply model centering offset
                    const old_x = modelB.position.x;
                    modelB.position.x = data.fighter_b_pos_x + modelB_offset_x;
                    modelB.position.z = data.fighter_b_pos_z + modelB_offset_z;
                    console.log('üîµ Updated Fighter B:', {
                        round: data.round_num,
                        sim_x: data.fighter_b_pos_x,
                        sim_z: data.fighter_b_pos_z,
                        offset_x: modelB_offset_x,
                        offset_z: modelB_offset_z,
                        old_actual_x: old_x,
                        new_actual_x: modelB.position.x,
                        new_actual_z: modelB.position.z
                    });
                }
                
                // Calculate and log distance between fighters
                if (modelA && modelB && data.fighter_a_pos_x !== undefined && data.fighter_b_pos_x !== undefined) {
                    const distance = Math.sqrt(
                        Math.pow(modelB.position.x - modelA.position.x, 2) + 
                        Math.pow(modelB.position.z - modelA.position.z, 2)
                    );
                    console.log('üìè DISTANCE between fighters:', {
                        round: data.round_num,
                        distance_3d: distance.toFixed(3),
                        distance_sim: Math.abs(data.fighter_b_pos_x - data.fighter_a_pos_x).toFixed(3),
                        a_x: modelA.position.x.toFixed(3),
                        b_x: modelB.position.x.toFixed(3)
                    });
                }
                
                // Update health/stamina bars
                if (data.fighter_a_health !== undefined) {
                    document.getElementById('health-a').style.width = Math.max(0, data.fighter_a_health) + '%';
                }
                if (data.fighter_b_health !== undefined) {
                    document.getElementById('health-b').style.width = Math.max(0, data.fighter_b_health) + '%';
                }
                if (data.fighter_a_stamina !== undefined) {
                    document.getElementById('stamina-a').style.width = Math.max(0, data.fighter_a_stamina) + '%';
                }
                if (data.fighter_b_stamina !== undefined) {
                    document.getElementById('stamina-b').style.width = Math.max(0, data.fighter_b_stamina) + '%';
                }
                
                // Update body part damage bars
                if (data.fighter_a_head_damage !== undefined) {
                    const headHealth = Math.max(0, 100 - data.fighter_a_head_damage);
                    document.getElementById('head-a').style.width = headHealth + '%';
                }
                if (data.fighter_a_body_damage !== undefined) {
                    const bodyHealth = Math.max(0, 100 - data.fighter_a_body_damage);
                    document.getElementById('body-a').style.width = bodyHealth + '%';
                }
                if (data.fighter_a_leg_damage !== undefined) {
                    const legHealth = Math.max(0, 100 - data.fighter_a_leg_damage);
                    document.getElementById('legs-a').style.width = legHealth + '%';
                }
                
                if (data.fighter_b_head_damage !== undefined) {
                    const headHealth = Math.max(0, 100 - data.fighter_b_head_damage);
                    document.getElementById('head-b').style.width = headHealth + '%';
                }
                if (data.fighter_b_body_damage !== undefined) {
                    const bodyHealth = Math.max(0, 100 - data.fighter_b_body_damage);
                    document.getElementById('body-b').style.width = bodyHealth + '%';
                }
                if (data.fighter_b_leg_damage !== undefined) {
                    const legHealth = Math.max(0, 100 - data.fighter_b_leg_damage);
                    document.getElementById('legs-b').style.width = legHealth + '%';
                }
            });

            eventSource.addEventListener('strike', (e) => {
                const data = JSON.parse(e.data);
                const evt = data.event;  // Extract the actual event data
                //const attacker = evt.attacker === 'A' ? fighterAName : fighterBName;
                const attacker = evt.attacker === 'A' ? dataA.name : dataB.name;
                const move = evt.move.toLowerCase().replace('_', ' ');
                const target = evt.target.toLowerCase();
                const damage = evt.damage || 0;
                const result = evt.result;
                
                if (result === 'LANDED_CLEAN' || result === 'LANDED_PARTIAL') {
                    const critical = damage > 15 ? ' critical' : '';
                    actionLog.innerHTML += `<div class="log-entry strike${critical}">${attacker} lands ${move} to ${target} (${damage.toFixed(1)} damage)</div>`;
                } else if (result === 'MISSED') {
                    actionLog.innerHTML += `<div class="log-entry miss">${attacker} misses with ${move}</div>`;
                } else if (result === 'BLOCKED') {
                    actionLog.innerHTML += `<div class="log-entry miss">${attacker}'s ${move} was blocked</div>`;
                }
                actionLog.scrollTop = actionLog.scrollHeight;
            });


            eventSource.addEventListener('round_end', (e) => {
                const data = JSON.parse(e.data);
                actionLog.innerHTML += `<div class="log-entry">End of Round ${data.round}</div>`;
                actionLog.scrollTop = actionLog.scrollHeight;
            });

            eventSource.addEventListener('fight_end', (e) => {
                const data = JSON.parse(e.data);
                document.getElementById('result').style.display = 'block';
                document.getElementById('result-title').textContent = `${data.winner} WINS!`;
                document.getElementById('result-message').textContent = `by ${data.method}`;
                eventSource.close();
            });

            eventSource.onerror = () => {
                eventSource.close();
            };
        }

        function updateHealthBars(data) {
            const suffix = data.fighter_id === fighterASelect.value ? '-a' : '-b';
            
            if (data.health !== undefined) {
                document.getElementById('health' + suffix).style.width = Math.max(0, data.health) + '%';
            }
            if (data.stamina !== undefined) {
                document.getElementById('stamina' + suffix).style.width = Math.max(0, data.stamina) + '%';
            }
            if (data.body_part && data[data.body_part] !== undefined) {
                document.getElementById(data.body_part + suffix).style.width = Math.max(0, data[data.body_part]) + '%';
            }
        }

        // Create fighter modal
        const modal = document.getElementById('create-fighter-modal');
        const createBtns = document.querySelectorAll('.create-fighter-btn');
        let currentCorner = 'a';

        createBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                currentCorner = btn.dataset.corner;
                modal.classList.add('active');
            });
        });

        document.getElementById('cancel-create').addEventListener('click', () => {
            modal.classList.remove('active');
            document.getElementById('fighter-description').value = '';
            document.getElementById('fighter-progress').style.display = 'none';
            document.getElementById('fighter-preview').style.display = 'none';
        });

        document.getElementById('generate-fighter').addEventListener('click', () => {
            const description = document.getElementById('fighter-description').value.trim();
            if (!description) return;

            const progressEl = document.getElementById('fighter-progress');
            const previewEl = document.getElementById('fighter-preview');
            progressEl.style.display = 'block';
            previewEl.style.display = 'none';

            // Use EventSource to handle SSE stream
            const eventSource = new EventSource(`/api/generate-fighter?description=${encodeURIComponent(description)}`);
            
            eventSource.onmessage = (e) => {
                const data = JSON.parse(e.data);
                console.log('SSE message:', data);
                
                if (data.type === 'complete') {
                    console.log('Fighter generated:', data);
                    
                    // Show preview
                    document.getElementById('preview-name').textContent = data.fighter_name;
                    document.getElementById('preview-height').textContent = data.physical.height_cm;
                    document.getElementById('preview-weight').textContent = data.physical.weight_kg;
                    document.getElementById('preview-age').textContent = data.physical.age;
                    document.getElementById('preview-power').textContent = data.stats.power.toFixed(1);
                    document.getElementById('preview-speed').textContent = data.stats.speed.toFixed(1);
                    document.getElementById('preview-cardio').textContent = data.stats.cardio.toFixed(1);

                    progressEl.style.display = 'none';
                    previewEl.style.display = 'block';

                    // Add to dropdown
                    const select = currentCorner === 'a' ? fighterASelect : fighterBSelect;
                    const option = document.createElement('option');
                    option.value = data.fighter_id;
                    option.textContent = data.fighter_name;
                    option.selected = true;
                    select.appendChild(option);

                    checkFightReady();
                    
                    eventSource.close();

                    setTimeout(() => {
                        modal.classList.remove('active');
                        document.getElementById('fighter-description').value = '';
                        previewEl.style.display = 'none';
                    }, 2000);
                } else if (data.type === 'error') {
                    console.error('Fighter generation error:', data.message);
                    alert(`Failed to generate fighter: ${data.message}`);
                    progressEl.style.display = 'none';
                    eventSource.close();
                }
                // Handle other message types (progress, stats_ready) if needed
            };
            
            eventSource.onerror = (e) => {
                console.error('EventSource error:', e);
                alert('Connection error. Please try again.');
                progressEl.style.display = 'none';
                eventSource.close();
            };
        });

        // Initialize
        loadFighters();
    </script>
</body>
</html>
