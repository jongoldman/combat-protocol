<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Fighter - Improved Geometry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background: #555;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #666;
        }
        
        button.active {
            background: #3b82f6;
        }
        
        .info {
            margin-top: 20px;
            font-size: 0.85rem;
            color: #999;
        }
        
        .info p {
            margin: 5px 0;
        }
        
        .tech-label {
            color: #4ade80;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="controls">
        <h2>Improved Geometry</h2>
        <button id="idle-btn" class="active">Fighting Stance</button>
        <button id="jab-btn">Jab</button>
        <button id="cross-btn">Cross</button>
        <button id="hook-btn">Lead Hook</button>
        <button id="kick-btn">Roundhouse Kick</button>
        <button id="block-btn">High Guard</button>
        
        <div class="info">
            <p class="tech-label">✓ Smooth tapered limbs</p>
            <p class="tech-label">✓ Natural proportions</p>
            <p class="tech-label">✓ Muscle definition</p>
            <p class="tech-label">✓ Rounded joints</p>
            <p>✓ Realistic biomechanics</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let leftFighter, rightFighter;
        let currentAnimation = 'idle';
        let time = 0;

        // Simple easing functions
        function easeInOut(t) {
            return t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2) / 2;
        }

        function easeOut(t) {
            return 1 - (1-t)*(1-t);
        }

        function easeIn(t) {
            return t * t;
        }

        // ===========================
        // ANIMATION SYSTEM (same as before)
        // ===========================
        
        class RealisticAnimator {
            constructor() {
                this.currentAnim = 'idle';
                this.animTime = 0;
            }
            
            setAnimation(name) {
                if (name !== this.currentAnim) {
                    this.currentAnim = name;
                    this.animTime = 0;
                }
            }
            
            update(dt) {
                this.animTime += dt;
            }
            
            getPose(fighter) {
                switch(this.currentAnim) {
                    case 'idle': return this.getIdlePose();
                    case 'jab': return this.getJabPose();
                    case 'cross': return this.getCrossPose();
                    case 'hook': return this.getHookPose();
                    case 'kick': return this.getKickPose();
                    case 'block': return this.getBlockPose();
                    default: return this.getIdlePose();
                }
            }
            
            getIdlePose() {
                const breathe = Math.sin(this.animTime * 1.5) * 0.01;
                const sway = Math.sin(this.animTime * 0.8) * 0.02;
                
                return {
                    hips: { x: 0, y: 0.05, z: 0 },
                    spine: { x: 0.05, y: 0, z: 0 },
                    chest: { x: 0, y: -0.1, z: 0 },
                    chestScale: 1 + breathe,
                    neck: { x: 0, y: 0, z: 0 },
                    head: { x: 0, y: 0, z: 0 },
                    leftShoulder: { x: -1.0, y: 0, z: 0.4 },
                    leftElbow: { x: -1.4, y: 0, z: 0 },
                    rightShoulder: { x: -1.0, y: 0, z: -0.3 },
                    rightElbow: { x: -1.5, y: 0, z: 0 },
                    leftThigh: { x: 0.1, y: 0, z: 0 },
                    leftKnee: { x: 0.2, y: 0, z: 0 },
                    rightThigh: { x: -0.05, y: 0, z: 0 },
                    rightKnee: { x: 0.25, y: 0, z: 0 }
                };
            }
            
            getJabPose() {
                const cycleTime = 0.6;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.15) {
                    const phase = t / 0.15;
                    return {
                        hips: { x: 0, y: 0.05 - phase * 0.03, z: 0 },
                        spine: { x: 0.05, y: phase * 0.08, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.08, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: 0, z: 0 },
                        leftShoulder: { x: -1.0, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4, y: 0, z: 0 },
                        rightShoulder: { x: -1.0 - phase * 0.1, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.2, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else if (t < 0.35) {
                    const phase = easeOut((t - 0.15) / 0.2);
                    return {
                        hips: { x: 0, y: 0.02 + phase * 0.06, z: 0 },
                        spine: { x: 0.05, y: 0.08 + phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.02 + phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        leftShoulder: { x: -1.1, y: 0, z: 0.4 },
                        leftElbow: { x: -1.5, y: 0, z: 0 },
                        rightShoulder: { x: -1.1 - phase * 0.5, y: 0, z: -0.3 },
                        rightElbow: { x: -1.3 + phase * 1.1, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.08, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.1, y: 0, z: 0 }
                    };
                } else {
                    const phase = 1.0 - easeIn((t - 0.35) / 0.65);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.03, z: 0 },
                        spine: { x: 0.05, y: phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        leftShoulder: { x: -1.0 - phase * 0.1, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.1, y: 0, z: 0 },
                        rightShoulder: { x: -1.0 - phase * 0.6, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.3, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.05, y: 0, z: 0 }
                    };
                }
            }
            
            getCrossPose() {
                const cycleTime = 0.8;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.2) {
                    const phase = t / 0.2;
                    return {
                        hips: { x: 0, y: -phase * 0.25, z: 0 },
                        spine: { x: 0.05, y: -phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.1 - phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: 0, y: -phase * 0.15, z: 0 },
                        leftShoulder: { x: -1.0, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4, y: 0, z: 0 },
                        rightShoulder: { x: -1.0 - phase * 0.2, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.1, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.2, y: 0, z: 0 }
                    };
                } else if (t < 0.4) {
                    const phase = easeOut((t - 0.2) / 0.2);
                    return {
                        hips: { x: 0, y: -0.25 + phase * 0.55, z: 0 },
                        spine: { x: 0.05, y: -0.15 + phase * 0.5, z: 0 },
                        chest: { x: 0, y: -0.3 + phase * 0.45, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.15, z: 0 },
                        head: { x: 0, y: -0.15 + phase * 0.2, z: 0 },
                        leftShoulder: { x: -1.2, y: 0, z: 0.5 },
                        leftElbow: { x: -1.6, y: 0, z: 0 },
                        rightShoulder: { x: -1.2 - phase * 0.6, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 1.3, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2 - phase * 0.05, y: 0, z: 0 },
                        rightThigh: { x: -0.15 + phase * 0.15, y: 0, z: 0 },
                        rightKnee: { x: 0.45 - phase * 0.25, y: 0, z: 0 }
                    };
                } else {
                    const phase = 1.0 - easeInOut((t - 0.4) / 0.6);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.25, z: 0 },
                        spine: { x: 0.05, y: phase * 0.3, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.25, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: phase * 0.05, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        leftShoulder: { x: -1.0 - phase * 0.2, y: 0, z: 0.4 + phase * 0.1 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        rightShoulder: { x: -1.0 - phase * 0.8, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.3, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.1, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.1, y: 0, z: 0 }
                    };
                }
            }
            
            getHookPose() {
                const cycleTime = 0.9;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.25) {
                    const phase = t / 0.25;
                    return {
                        hips: { x: 0, y: -phase * 0.35, z: 0 },
                        spine: { x: 0.05, y: -phase * 0.25, z: 0 },
                        chest: { x: 0, y: -0.1 - phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: 0, y: -phase * 0.15, z: 0 },
                        leftShoulder: { x: -1.0 + phase * 0.3, y: -phase * 0.5, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        rightShoulder: { x: -1.2, y: 0, z: -0.3 },
                        rightElbow: { x: -1.6, y: 0, z: 0 },
                        leftThigh: { x: 0.1 - phase * 0.15, y: 0, z: 0 },
                        leftKnee: { x: 0.2 + phase * 0.15, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else if (t < 0.45) {
                    const phase = easeOut((t - 0.25) / 0.2);
                    return {
                        hips: { x: 0, y: -0.35 + phase * 0.8, z: 0 },
                        spine: { x: 0.05, y: -0.25 + phase * 0.7, z: 0 },
                        chest: { x: 0, y: -0.3 + phase * 0.6, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.25, z: 0 },
                        head: { x: 0, y: -0.15 + phase * 0.3, z: 0 },
                        leftShoulder: { x: -0.7 - phase * 0.2, y: -0.5 + phase * 1.3, z: 0.4 },
                        leftElbow: { x: -1.6, y: 0, z: 0 },
                        rightShoulder: { x: -1.3, y: 0, z: -0.2 },
                        rightElbow: { x: -1.7, y: 0, z: 0 },
                        leftThigh: { x: -0.05, y: phase * 0.2, z: 0 },
                        leftKnee: { x: 0.35 - phase * 0.1, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else {
                    const phase = 1.0 - easeInOut((t - 0.45) / 0.55);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.4, z: 0 },
                        spine: { x: 0.05, y: phase * 0.4, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.3, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: phase * 0.15, z: 0 },
                        head: { x: 0, y: phase * 0.15, z: 0 },
                        leftShoulder: { x: -1.0 + phase * 0.1, y: phase * 0.8, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        rightShoulder: { x: -1.0 - phase * 0.3, y: 0, z: -0.3 + phase * 0.1 },
                        rightElbow: { x: -1.5 - phase * 0.2, y: 0, z: 0 },
                        leftThigh: { x: 0.1 + phase * -0.15, y: phase * 0.2, z: 0 },
                        leftKnee: { x: 0.2 + phase * 0.15, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                }
            }
            
            getKickPose() {
                const cycleTime = 1.2;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.3) {
                    const phase = easeInOut(t / 0.3);
                    return {
                        hips: { x: 0, y: -phase * 0.4, z: 0 },
                        spine: { x: 0.05 - phase * 0.1, y: -phase * 0.25, z: 0 },
                        chest: { x: -phase * 0.1, y: -0.1 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: -phase * 0.05, y: -phase * 0.1, z: 0 },
                        leftShoulder: { x: -0.8, y: -phase * 0.3, z: 0.4 },
                        leftElbow: { x: -1.2 + phase * 0.4, y: 0, z: 0 },
                        rightShoulder: { x: -0.8, y: phase * 0.3, z: -0.3 },
                        rightElbow: { x: -1.2 + phase * 0.4, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },
                        rightThigh: { x: phase * 1.5, y: 0, z: 0 },
                        rightKnee: { x: 0.25 - phase * 1.8, y: 0, z: 0 }
                    };
                } else if (t < 0.5) {
                    const phase = easeOut((t - 0.3) / 0.2);
                    return {
                        hips: { x: 0, y: -0.4 + phase * 0.9, z: 0 },
                        spine: { x: -0.05 - phase * 0.1, y: -0.25 + phase * 0.55, z: 0 },
                        chest: { x: -0.1 - phase * 0.1, y: -0.25 + phase * 0.45, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.2, z: 0 },
                        head: { x: -0.05 - phase * 0.1, y: -0.1 + phase * 0.15, z: 0 },
                        leftShoulder: { x: -0.8, y: -0.3 - phase * 0.3, z: 0.4 },
                        leftElbow: { x: -0.8, y: 0, z: 0 },
                        rightShoulder: { x: -0.8, y: 0.3 + phase * 0.3, z: -0.3 },
                        rightElbow: { x: -0.8, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },
                        rightThigh: { x: 1.5 - phase * 0.6, y: phase * 0.8, z: 0 },
                        rightKnee: { x: -1.55 + phase * 1.4, y: 0, z: 0 }
                    };
                } else if (t < 0.7) {
                    const phase = (t - 0.5) / 0.2;
                    return {
                        hips: { x: 0, y: 0.5 - phase * 0.4, z: 0 },
                        spine: { x: -0.15 + phase * 0.1, y: 0.3 - phase * 0.2, z: 0 },
                        chest: { x: -0.2 + phase * 0.1, y: 0.2 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0.1 - phase * 0.05, z: 0 },
                        head: { x: -0.15 + phase * 0.05, y: 0.05 - phase * 0.03, z: 0 },
                        leftShoulder: { x: -0.8, y: -0.6 + phase * 0.3, z: 0.4 },
                        leftElbow: { x: -0.8 - phase * 0.2, y: 0, z: 0 },
                        rightShoulder: { x: -0.8, y: 0.6 - phase * 0.3, z: -0.3 },
                        rightElbow: { x: -0.8 - phase * 0.2, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },
                        rightThigh: { x: 0.9 + phase * 0.4, y: 0.8 - phase * 0.5, z: 0 },
                        rightKnee: { x: -0.15 - phase * 0.8, y: 0, z: 0 }
                    };
                } else {
                    const phase = easeInOut((t - 0.7) / 0.3);
                    return {
                        hips: { x: 0, y: 0.1 - phase * 0.05, z: 0 },
                        spine: { x: 0.05 - phase * 0.05, y: 0.1 - phase * 0.1, z: 0 },
                        chest: { x: -0.1 + phase * 0.1, y: 0.05 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0.05 - phase * 0.05, z: 0 },
                        head: { x: -0.1 + phase * 0.1, y: 0.02 - phase * 0.02, z: 0 },
                        leftShoulder: { x: -0.8 - phase * 0.2, y: -0.3 + phase * 0.3, z: 0.4 },
                        leftElbow: { x: -1.0 - phase * 0.4, y: 0, z: 0 },
                        rightShoulder: { x: -0.8 - phase * 0.2, y: 0.3 - phase * 0.3, z: -0.3 },
                        rightElbow: { x: -1.0 - phase * 0.5, y: 0, z: 0 },
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25 - phase * 0.05, y: 0, z: 0 },
                        rightThigh: { x: 1.3 - phase * 1.35, y: 0.3 - phase * 0.3, z: 0 },
                        rightKnee: { x: -0.95 + phase * 1.2, y: 0, z: 0 }
                    };
                }
            }
            
            getBlockPose() {
                return {
                    hips: { x: 0, y: 0, z: 0 },
                    spine: { x: 0.1, y: 0, z: 0 },
                    chest: { x: 0, y: -0.05, z: 0 },
                    chestScale: 0.98,
                    neck: { x: 0.25, y: 0, z: 0 },
                    head: { x: -0.15, y: 0, z: 0 },
                    leftShoulder: { x: -1.6, y: 0, z: 0.5 },
                    leftElbow: { x: -1.8, y: 0, z: 0 },
                    rightShoulder: { x: -1.6, y: 0, z: -0.5 },
                    rightElbow: { x: -1.8, y: 0, z: 0 },
                    leftThigh: { x: 0.1, y: 0, z: 0 },
                    leftKnee: { x: 0.3, y: 0, z: 0 },
                    rightThigh: { x: -0.05, y: 0, z: 0 },
                    rightKnee: { x: 0.35, y: 0, z: 0 }
                };
            }
        }

        // ===========================
        // THREE.JS SETUP
        // ===========================

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 3, 10);
            camera.lookAt(0, 2, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const spotLight = new THREE.SpotLight(0xffffff, 1);
            spotLight.position.set(0, 15, 0);
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 2048;
            spotLight.shadow.mapSize.height = 2048;
            scene.add(spotLight);

            const rimLight = new THREE.DirectionalLight(0x4444ff, 0.5);
            rimLight.position.set(5, 5, -5);
            scene.add(rimLight);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a2a,
                roughness: 0.8,
                metalness: 0.2
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Ring ropes
            const ropeGeometry = new THREE.CylinderGeometry(0.05, 0.05, 12, 16);
            const ropeMaterial = new THREE.MeshStandardMaterial({ color: 0xcc0000 });
            
            for (let i = 0; i < 3; i++) {
                const height = 0.5 + i * 0.5;
                const rope1 = new THREE.Mesh(ropeGeometry, ropeMaterial);
                rope1.rotation.z = Math.PI / 2;
                rope1.position.set(0, height, -6);
                scene.add(rope1);
                
                const rope2 = rope1.clone();
                rope2.position.z = 6;
                scene.add(rope2);
            }

            // Create fighters with better geometry
            leftFighter = createImprovedFighter(0xff4444, -3);
            rightFighter = createImprovedFighter(0x4444ff, 3);
            scene.add(leftFighter.group);
            scene.add(rightFighter.group);

            // Button handlers
            document.getElementById('idle-btn').onclick = () => setAnimation('idle');
            document.getElementById('jab-btn').onclick = () => setAnimation('jab');
            document.getElementById('cross-btn').onclick = () => setAnimation('cross');
            document.getElementById('hook-btn').onclick = () => setAnimation('hook');
            document.getElementById('kick-btn').onclick = () => setAnimation('kick');
            document.getElementById('block-btn').onclick = () => setAnimation('block');

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createImprovedFighter(color, xPosition) {
            const fighter = {
                group: new THREE.Group(),
                animator: new RealisticAnimator(),
                bones: {}
            };
            
            fighter.group.position.x = xPosition;

            // Better materials with more detail
            const skinMaterial = new THREE.MeshStandardMaterial({
                color: color,
                roughness: 0.6,
                metalness: 0.1,
                flatShading: false  // Smooth shading
            });

            const darkMaterial = new THREE.MeshStandardMaterial({
                color: new THREE.Color(color).multiplyScalar(0.6),
                roughness: 0.7,
                metalness: 0.2
            });

            // === HIPS ===
            const hips = new THREE.Group();
            hips.position.y = 1.0;
            fighter.group.add(hips);
            fighter.bones.hips = hips;

            // More rounded hip geometry
            const hipsGeometry = new THREE.SphereGeometry(0.35, 16, 12);
            hipsGeometry.scale(1.6, 0.7, 1.0);  // Wider, flatter
            const hipsMesh = new THREE.Mesh(hipsGeometry, darkMaterial);
            hipsMesh.castShadow = true;
            hips.add(hipsMesh);

            // === SPINE/ABDOMEN ===
            const spine = new THREE.Group();
            spine.position.y = 0.3;
            hips.add(spine);
            fighter.bones.spine = spine;

            // Tapered torso
            const spineGeometry = new THREE.CylinderGeometry(0.25, 0.3, 0.45, 16);
            const spineMesh = new THREE.Mesh(spineGeometry, skinMaterial);
            spineMesh.position.y = 0.225;
            spineMesh.castShadow = true;
            spine.add(spineMesh);

            // === CHEST/TORSO ===
            const chest = new THREE.Group();
            chest.position.y = 0.45;
            spine.add(chest);
            fighter.bones.chest = chest;

            // More anatomical chest - wider at top
            const chestGeometry = new THREE.SphereGeometry(0.4, 20, 16);
            chestGeometry.scale(1.6, 1.3, 0.85);  // Wide shoulders, deep chest
            const chestMesh = new THREE.Mesh(chestGeometry, skinMaterial);
            chestMesh.position.y = 0.3;
            chestMesh.castShadow = true;
            chest.add(chestMesh);
            fighter.bones.chestMesh = chestMesh;

            // === NECK ===
            const neck = new THREE.Group();
            neck.position.y = 0.6;
            chest.add(neck);
            fighter.bones.neck = neck;

            // Thicker, more muscular neck
            const neckGeometry = new THREE.CylinderGeometry(0.14, 0.18, 0.28, 16);
            const neckMesh = new THREE.Mesh(neckGeometry, skinMaterial);
            neckMesh.position.y = 0.14;
            neckMesh.castShadow = true;
            neck.add(neckMesh);

            // === HEAD ===
            const head = new THREE.Group();
            head.position.y = 0.28;
            neck.add(head);
            fighter.bones.head = head;

            // More realistic skull shape
            const headGeometry = new THREE.SphereGeometry(0.28, 20, 20);
            headGeometry.scale(0.95, 1.1, 1.0);  // Slightly elongated
            const headMesh = new THREE.Mesh(headGeometry, skinMaterial);
            headMesh.position.y = 0.28;
            headMesh.castShadow = true;
            head.add(headMesh);

            // Chin/jaw definition
            const jawGeometry = new THREE.SphereGeometry(0.15, 12, 12);
            jawGeometry.scale(1.2, 0.6, 1.0);
            const jawMesh = new THREE.Mesh(jawGeometry, skinMaterial);
            jawMesh.position.set(0, 0.15, 0.08);
            jawMesh.castShadow = true;
            head.add(jawMesh);

            // === ARMS (LEFT & RIGHT) ===
            ['left', 'right'].forEach(side => {
                const sign = side === 'left' ? 1 : -1;
                
                // SHOULDER
                const shoulder = new THREE.Group();
                shoulder.position.set(sign * 0.45, 0.45, 0);  // Wider shoulders
                chest.add(shoulder);
                fighter.bones[`${side}Shoulder`] = shoulder;

                // Rounded deltoid
                const shoulderGeometry = new THREE.SphereGeometry(0.15, 16, 16);
                shoulderGeometry.scale(1.1, 1.0, 1.0);
                const shoulderMesh = new THREE.Mesh(shoulderGeometry, skinMaterial);
                shoulderMesh.castShadow = true;
                shoulder.add(shoulderMesh);

                // UPPER ARM (tapered)
                const upperArm = new THREE.Group();
                upperArm.position.y = -0.15;
                shoulder.add(upperArm);

                const upperArmGeometry = new THREE.CylinderGeometry(0.085, 0.11, 0.38, 16);
                const upperArmMesh = new THREE.Mesh(upperArmGeometry, skinMaterial);
                upperArmMesh.position.y = -0.19;
                upperArmMesh.castShadow = true;
                upperArm.add(upperArmMesh);

                // Bicep bulge
                const bicepGeometry = new THREE.SphereGeometry(0.13, 12, 12);
                bicepGeometry.scale(0.8, 1.0, 0.8);
                const bicepMesh = new THREE.Mesh(bicepGeometry, skinMaterial);
                bicepMesh.position.y = -0.12;
                bicepMesh.castShadow = true;
                upperArm.add(bicepMesh);

                // ELBOW
                const elbow = new THREE.Group();
                elbow.position.y = -0.38;
                upperArm.add(elbow);
                fighter.bones[`${side}Elbow`] = elbow;

                const elbowGeometry = new THREE.SphereGeometry(0.095, 14, 14);
                const elbowMesh = new THREE.Mesh(elbowGeometry, skinMaterial);
                elbowMesh.castShadow = true;
                elbow.add(elbowMesh);

                // FOREARM (tapered toward wrist)
                const forearm = new THREE.Group();
                forearm.position.y = -0.1;
                elbow.add(forearm);

                const forearmGeometry = new THREE.CylinderGeometry(0.07, 0.095, 0.36, 16);
                const forearmMesh = new THREE.Mesh(forearmGeometry, skinMaterial);
                forearmMesh.position.y = -0.18;
                forearmMesh.castShadow = true;
                forearm.add(forearmMesh);

                // GLOVE (larger, more padded)
                const gloveGeometry = new THREE.SphereGeometry(0.14, 14, 14);
                gloveGeometry.scale(1.1, 0.9, 1.0);
                const gloveMesh = new THREE.Mesh(gloveGeometry, darkMaterial);
                gloveMesh.position.y = -0.4;
                gloveMesh.castShadow = true;
                forearm.add(gloveMesh);
            });

            // === LEGS (LEFT & RIGHT) ===
            ['left', 'right'].forEach(side => {
                const sign = side === 'left' ? 1 : -1;
                
                // THIGH
                const thigh = new THREE.Group();
                thigh.position.set(sign * 0.22, -0.15, 0);
                hips.add(thigh);
                fighter.bones[`${side}Thigh`] = thigh;

                // Muscular thigh (tapered)
                const thighGeometry = new THREE.CylinderGeometry(0.13, 0.16, 0.54, 16);
                const thighMesh = new THREE.Mesh(thighGeometry, skinMaterial);
                thighMesh.position.y = -0.27;
                thighMesh.castShadow = true;
                thigh.add(thighMesh);

                // Quad definition
                const quadGeometry = new THREE.SphereGeometry(0.17, 12, 12);
                quadGeometry.scale(0.8, 1.2, 0.9);
                const quadMesh = new THREE.Mesh(quadGeometry, skinMaterial);
                quadMesh.position.set(0, -0.15, 0.02);
                quadMesh.castShadow = true;
                thigh.add(quadMesh);

                // KNEE
                const knee = new THREE.Group();
                knee.position.y = -0.54;
                thigh.add(knee);
                fighter.bones[`${side}Knee`] = knee;

                const kneeGeometry = new THREE.SphereGeometry(0.12, 14, 14);
                const kneeMesh = new THREE.Mesh(kneeGeometry, skinMaterial);
                kneeMesh.castShadow = true;
                knee.add(kneeMesh);

                // SHIN (tapered toward ankle)
                const shin = new THREE.Group();
                shin.position.y = -0.1;
                knee.add(shin);

                const shinGeometry = new THREE.CylinderGeometry(0.09, 0.12, 0.48, 16);
                const shinMesh = new THREE.Mesh(shinGeometry, skinMaterial);
                shinMesh.position.y = -0.24;
                shinMesh.castShadow = true;
                shin.add(shinMesh);

                // Calf muscle
                const calfGeometry = new THREE.SphereGeometry(0.13, 12, 12);
                calfGeometry.scale(0.8, 1.1, 0.9);
                const calfMesh = new THREE.Mesh(calfGeometry, skinMaterial);
                calfMesh.position.set(0, -0.12, 0.02);
                calfMesh.castShadow = true;
                shin.add(calfMesh);

                // FOOT (more anatomical)
                const footGeometry = new THREE.BoxGeometry(0.16, 0.12, 0.32);
                footGeometry.translate(0, 0, 0.08);  // Heel to toe
                const footMesh = new THREE.Mesh(footGeometry, darkMaterial);
                footMesh.position.set(0, -0.52, 0);
                footMesh.castShadow = true;
                shin.add(footMesh);

                // Rounded toe
                const toeGeometry = new THREE.SphereGeometry(0.08, 10, 10);
                toeGeometry.scale(1.0, 0.7, 1.2);
                const toeMesh = new THREE.Mesh(toeGeometry, darkMaterial);
                toeMesh.position.set(0, -0.52, 0.2);
                toeMesh.castShadow = true;
                shin.add(toeMesh);
            });

            return fighter;
        }

        function updateFighterAnimation(fighter) {
            fighter.animator.update(0.016);
            const pose = fighter.animator.getPose(fighter);
            
            const bones = fighter.bones;
            
            bones.hips.rotation.set(pose.hips.x, pose.hips.y, pose.hips.z);
            bones.spine.rotation.set(pose.spine.x, pose.spine.y, pose.spine.z);
            bones.chest.rotation.set(pose.chest.x, pose.chest.y, pose.chest.z);
            bones.chestMesh.scale.y = pose.chestScale || 1;
            bones.neck.rotation.set(pose.neck.x, pose.neck.y, pose.neck.z);
            bones.head.rotation.set(pose.head.x, pose.head.y, pose.head.z);
            
            bones.leftShoulder.rotation.set(pose.leftShoulder.x, pose.leftShoulder.y, pose.leftShoulder.z);
            bones.leftElbow.rotation.set(pose.leftElbow.x, pose.leftElbow.y, pose.leftElbow.z);
            bones.rightShoulder.rotation.set(pose.rightShoulder.x, pose.rightShoulder.y, pose.rightShoulder.z);
            bones.rightElbow.rotation.set(pose.rightElbow.x, pose.rightElbow.y, pose.rightElbow.z);
            
            bones.leftThigh.rotation.set(pose.leftThigh.x, pose.leftThigh.y, pose.leftThigh.z);
            bones.leftKnee.rotation.set(pose.leftKnee.x, pose.leftKnee.y, pose.leftKnee.z);
            bones.rightThigh.rotation.set(pose.rightThigh.x, pose.rightThigh.y, pose.rightThigh.z);
            bones.rightKnee.rotation.set(pose.rightKnee.x, pose.rightKnee.y, pose.rightKnee.z);
        }

        function setAnimation(anim) {
            currentAnimation = anim;
            leftFighter.animator.setAnimation(anim);
            rightFighter.animator.setAnimation(anim);
            
            document.querySelectorAll('#controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(anim + '-btn').classList.add('active');
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;

            updateFighterAnimation(leftFighter);
            updateFighterAnimation(rightFighter);

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
