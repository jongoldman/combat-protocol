<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Fighter - Realistic Biomechanics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 10px;
            color: white;
        }
        
        h2 {
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        button {
            display: block;
            width: 100%;
            padding: 10px 20px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background: #555;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        button:hover {
            background: #666;
        }
        
        button.active {
            background: #3b82f6;
        }
        
        .info {
            margin-top: 20px;
            font-size: 0.85rem;
            color: #999;
        }
        
        .info p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="controls">
        <h2>Realistic Biomechanics</h2>
        <button id="idle-btn" class="active">Fighting Stance</button>
        <button id="jab-btn">Jab (Rear Hand)</button>
        <button id="cross-btn">Cross (Power)</button>
        <button id="hook-btn">Lead Hook</button>
        <button id="kick-btn">Roundhouse Kick</button>
        <button id="block-btn">High Guard</button>
        
        <div class="info">
            <p>✓ Proper kinetic chain</p>
            <p>✓ Weight transfer</p>
            <p>✓ Sequential activation</p>
            <p>✓ Realistic timing</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer;
        let leftFighter, rightFighter;
        let currentAnimation = 'idle';
        let time = 0;

        // Simple but smooth easing
        function easeInOut(t) {
            return t < 0.5 ? 2*t*t : 1 - Math.pow(-2*t + 2, 2) / 2;
        }

        function easeOut(t) {
            return 1 - (1-t)*(1-t);
        }

        function easeIn(t) {
            return t * t;
        }

        // ===========================
        // ANIMATION SYSTEM
        // ===========================
        
        class RealisticAnimator {
            constructor() {
                this.currentAnim = 'idle';
                this.animTime = 0;
            }
            
            setAnimation(name) {
                if (name !== this.currentAnim) {
                    this.currentAnim = name;
                    this.animTime = 0;
                }
            }
            
            update(dt) {
                this.animTime += dt;
            }
            
            getPose(fighter) {
                switch(this.currentAnim) {
                    case 'idle': return this.getIdlePose();
                    case 'jab': return this.getJabPose();
                    case 'cross': return this.getCrossPose();
                    case 'hook': return this.getHookPose();
                    case 'kick': return this.getKickPose();
                    case 'block': return this.getBlockPose();
                    default: return this.getIdlePose();
                }
            }
            
            getIdlePose() {
                // Orthodox fighting stance - left foot forward
                const breathe = Math.sin(this.animTime * 1.5) * 0.01;
                
                return {
                    // Core
                    hips: { x: 0, y: 0.05, z: 0 },  // Slight forward lean
                    spine: { x: 0.05, y: 0, z: 0 },
                    chest: { x: 0, y: -0.1, z: 0 },  // Shoulders slightly back
                    chestScale: 1 + breathe,
                    
                    // Head
                    neck: { x: 0, y: 0, z: 0 },
                    head: { x: 0, y: 0, z: 0 },
                    
                    // Left arm (lead hand) - guard position
                    leftShoulder: { x: -1.0, y: 0, z: 0.4 },  // Up and forward
                    leftElbow: { x: -1.4, y: 0, z: 0 },       // Bent 90°
                    
                    // Right arm (rear hand) - guard position
                    rightShoulder: { x: -1.0, y: 0, z: -0.3 }, // Up, protecting face
                    rightElbow: { x: -1.5, y: 0, z: 0 },       // Bent tight
                    
                    // Legs - athletic stance
                    leftThigh: { x: 0.1, y: 0, z: 0 },   // Left leg slightly forward
                    leftKnee: { x: 0.2, y: 0, z: 0 },    // Slight bend
                    rightThigh: { x: -0.05, y: 0, z: 0 }, // Right leg back
                    rightKnee: { x: 0.25, y: 0, z: 0 }    // More bend for power
                };
            }
            
            getJabPose() {
                // Rear hand (right) jab - fast, straight, weight stays mostly on back leg
                const cycleTime = 0.6;  // Total animation time
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.15) {
                    // Subtle wind-up (chamber)
                    const phase = t / 0.15;
                    return {
                        hips: { x: 0, y: 0.05 - phase * 0.03, z: 0 },
                        spine: { x: 0.05, y: phase * 0.08, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.08, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: 0, z: 0 },
                        
                        // Left stays in guard
                        leftShoulder: { x: -1.0, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4, y: 0, z: 0 },
                        
                        // Right chambers slightly
                        rightShoulder: { x: -1.0 - phase * 0.1, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.2, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else if (t < 0.35) {
                    // Extension - fast and direct
                    const phase = easeOut((t - 0.15) / 0.2);
                    return {
                        hips: { x: 0, y: 0.02 + phase * 0.06, z: 0 },
                        spine: { x: 0.05, y: 0.08 + phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.02 + phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        
                        // Left protects
                        leftShoulder: { x: -1.1, y: 0, z: 0.4 },
                        leftElbow: { x: -1.5, y: 0, z: 0 },
                        
                        // Right extends fully
                        rightShoulder: { x: -1.1 - phase * 0.5, y: 0, z: -0.3 },
                        rightElbow: { x: -1.3 + phase * 1.1, y: 0, z: 0 },  // Straightens
                        
                        // Small push from back leg
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.08, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.1, y: 0, z: 0 }
                    };
                } else {
                    // Return to guard - quick snap back
                    const phase = 1.0 - easeIn((t - 0.35) / 0.65);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.03, z: 0 },
                        spine: { x: 0.05, y: phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        
                        leftShoulder: { x: -1.0 - phase * 0.1, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.1, y: 0, z: 0 },
                        
                        rightShoulder: { x: -1.0 - phase * 0.6, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.3, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.05, y: 0, z: 0 }
                    };
                }
            }
            
            getCrossPose() {
                // Power cross - full body rotation, weight transfer
                const cycleTime = 0.8;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.2) {
                    // Load - sink into back leg
                    const phase = t / 0.2;
                    return {
                        hips: { x: 0, y: -phase * 0.25, z: 0 },
                        spine: { x: 0.05, y: -phase * 0.15, z: 0 },
                        chest: { x: 0, y: -0.1 - phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: 0, y: -phase * 0.15, z: 0 },
                        
                        leftShoulder: { x: -1.0, y: 0, z: 0.4 },
                        leftElbow: { x: -1.4, y: 0, z: 0 },
                        
                        rightShoulder: { x: -1.0 - phase * 0.2, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.1, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.2, y: 0, z: 0 }  // Deep bend
                    };
                } else if (t < 0.4) {
                    // Explosion - ground up: hips → spine → shoulder → fist
                    const phase = easeOut((t - 0.2) / 0.2);
                    return {
                        hips: { x: 0, y: -0.25 + phase * 0.55, z: 0 },
                        spine: { x: 0.05, y: -0.15 + phase * 0.5, z: 0 },
                        chest: { x: 0, y: -0.3 + phase * 0.45, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.15, z: 0 },
                        head: { x: 0, y: -0.15 + phase * 0.2, z: 0 },
                        
                        // Left hand guards face
                        leftShoulder: { x: -1.2, y: 0, z: 0.5 },
                        leftElbow: { x: -1.6, y: 0, z: 0 },
                        
                        // Right extends with full rotation
                        rightShoulder: { x: -1.2 - phase * 0.6, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 1.3, y: 0, z: 0 },
                        
                        // Drive from back leg
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2 - phase * 0.05, y: 0, z: 0 },
                        rightThigh: { x: -0.15 + phase * 0.15, y: 0, z: 0 },
                        rightKnee: { x: 0.45 - phase * 0.25, y: 0, z: 0 }
                    };
                } else {
                    // Recovery
                    const phase = 1.0 - easeInOut((t - 0.4) / 0.6);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.25, z: 0 },
                        spine: { x: 0.05, y: phase * 0.3, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.25, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: phase * 0.05, z: 0 },
                        head: { x: 0, y: phase * 0.05, z: 0 },
                        
                        leftShoulder: { x: -1.0 - phase * 0.2, y: 0, z: 0.4 + phase * 0.1 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        
                        rightShoulder: { x: -1.0 - phase * 0.8, y: 0, z: -0.3 },
                        rightElbow: { x: -1.5 + phase * 0.3, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.2, y: 0, z: 0 },
                        rightThigh: { x: -0.05 - phase * 0.1, y: 0, z: 0 },
                        rightKnee: { x: 0.25 + phase * 0.1, y: 0, z: 0 }
                    };
                }
            }
            
            getHookPose() {
                // Lead (left) hook - rotation from the floor up
                const cycleTime = 0.9;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.25) {
                    // Load into front leg, slight counter-rotation
                    const phase = t / 0.25;
                    return {
                        hips: { x: 0, y: -phase * 0.35, z: 0 },
                        spine: { x: 0.05, y: -phase * 0.25, z: 0 },
                        chest: { x: 0, y: -0.1 - phase * 0.2, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: 0, y: -phase * 0.15, z: 0 },
                        
                        // Left arm cocks
                        leftShoulder: { x: -1.0 + phase * 0.3, y: -phase * 0.5, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        
                        // Right protects
                        rightShoulder: { x: -1.2, y: 0, z: -0.3 },
                        rightElbow: { x: -1.6, y: 0, z: 0 },
                        
                        // Weight shifts to lead leg
                        leftThigh: { x: 0.1 - phase * 0.15, y: 0, z: 0 },
                        leftKnee: { x: 0.2 + phase * 0.15, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else if (t < 0.45) {
                    // Explosive pivot - hips drive the punch
                    const phase = easeOut((t - 0.25) / 0.2);
                    return {
                        hips: { x: 0, y: -0.35 + phase * 0.8, z: 0 },
                        spine: { x: 0.05, y: -0.25 + phase * 0.7, z: 0 },
                        chest: { x: 0, y: -0.3 + phase * 0.6, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.25, z: 0 },
                        head: { x: 0, y: -0.15 + phase * 0.3, z: 0 },
                        
                        // Left hooks across
                        leftShoulder: { x: -0.7 - phase * 0.2, y: -0.5 + phase * 1.3, z: 0.4 },
                        leftElbow: { x: -1.6, y: 0, z: 0 },  // Stays bent
                        
                        // Right stays tight
                        rightShoulder: { x: -1.3, y: 0, z: -0.2 },
                        rightElbow: { x: -1.7, y: 0, z: 0 },
                        
                        // Pivot on ball of lead foot
                        leftThigh: { x: -0.05, y: phase * 0.2, z: 0 },
                        leftKnee: { x: 0.35 - phase * 0.1, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                } else {
                    // Return
                    const phase = 1.0 - easeInOut((t - 0.45) / 0.55);
                    return {
                        hips: { x: 0, y: 0.05 + phase * 0.4, z: 0 },
                        spine: { x: 0.05, y: phase * 0.4, z: 0 },
                        chest: { x: 0, y: -0.1 + phase * 0.3, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: phase * 0.15, z: 0 },
                        head: { x: 0, y: phase * 0.15, z: 0 },
                        
                        leftShoulder: { x: -1.0 + phase * 0.1, y: phase * 0.8, z: 0.4 },
                        leftElbow: { x: -1.4 - phase * 0.2, y: 0, z: 0 },
                        
                        rightShoulder: { x: -1.0 - phase * 0.3, y: 0, z: -0.3 + phase * 0.1 },
                        rightElbow: { x: -1.5 - phase * 0.2, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1 + phase * -0.15, y: phase * 0.2, z: 0 },
                        leftKnee: { x: 0.2 + phase * 0.15, y: 0, z: 0 },
                        rightThigh: { x: -0.05, y: 0, z: 0 },
                        rightKnee: { x: 0.25, y: 0, z: 0 }
                    };
                }
            }
            
            getKickPose() {
                // Right leg roundhouse - classic Muay Thai
                const cycleTime = 1.2;
                const t = (this.animTime % cycleTime) / cycleTime;
                
                if (t < 0.3) {
                    // Chamber - lift knee, rotate hips
                    const phase = easeInOut(t / 0.3);
                    return {
                        hips: { x: 0, y: -phase * 0.4, z: 0 },
                        spine: { x: 0.05 - phase * 0.1, y: -phase * 0.25, z: 0 },
                        chest: { x: -phase * 0.1, y: -0.1 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -phase * 0.1, z: 0 },
                        head: { x: -phase * 0.05, y: -phase * 0.1, z: 0 },
                        
                        // Arms for balance
                        leftShoulder: { x: -0.8, y: -phase * 0.3, z: 0.4 },
                        leftElbow: { x: -1.2 + phase * 0.4, y: 0, z: 0 },
                        
                        rightShoulder: { x: -0.8, y: phase * 0.3, z: -0.3 },
                        rightElbow: { x: -1.2 + phase * 0.4, y: 0, z: 0 },
                        
                        // Stand on left leg, chamber right
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },  // Slight bend for balance
                        rightThigh: { x: phase * 1.5, y: 0, z: 0 },  // Lift knee
                        rightKnee: { x: 0.25 - phase * 1.8, y: 0, z: 0 }  // Tuck shin
                    };
                } else if (t < 0.5) {
                    // Extension - shin whips through
                    const phase = easeOut((t - 0.3) / 0.2);
                    return {
                        hips: { x: 0, y: -0.4 + phase * 0.9, z: 0 },
                        spine: { x: -0.05 - phase * 0.1, y: -0.25 + phase * 0.55, z: 0 },
                        chest: { x: -0.1 - phase * 0.1, y: -0.25 + phase * 0.45, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: -0.1 + phase * 0.2, z: 0 },
                        head: { x: -0.05 - phase * 0.1, y: -0.1 + phase * 0.15, z: 0 },
                        
                        // Arms swing for momentum
                        leftShoulder: { x: -0.8, y: -0.3 - phase * 0.3, z: 0.4 },
                        leftElbow: { x: -0.8, y: 0, z: 0 },
                        
                        rightShoulder: { x: -0.8, y: 0.3 + phase * 0.3, z: -0.3 },
                        rightElbow: { x: -0.8, y: 0, z: 0 },
                        
                        // Balance
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },
                        
                        // Kick extends
                        rightThigh: { x: 1.5 - phase * 0.6, y: phase * 0.8, z: 0 },
                        rightKnee: { x: -1.55 + phase * 1.4, y: 0, z: 0 }  // Extends
                    };
                } else if (t < 0.7) {
                    // Retract
                    const phase = (t - 0.5) / 0.2;
                    return {
                        hips: { x: 0, y: 0.5 - phase * 0.4, z: 0 },
                        spine: { x: -0.15 + phase * 0.1, y: 0.3 - phase * 0.2, z: 0 },
                        chest: { x: -0.2 + phase * 0.1, y: 0.2 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0.1 - phase * 0.05, z: 0 },
                        head: { x: -0.15 + phase * 0.05, y: 0.05 - phase * 0.03, z: 0 },
                        
                        leftShoulder: { x: -0.8, y: -0.6 + phase * 0.3, z: 0.4 },
                        leftElbow: { x: -0.8 - phase * 0.2, y: 0, z: 0 },
                        
                        rightShoulder: { x: -0.8, y: 0.6 - phase * 0.3, z: -0.3 },
                        rightElbow: { x: -0.8 - phase * 0.2, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25, y: 0, z: 0 },
                        
                        // Pull back
                        rightThigh: { x: 0.9 + phase * 0.4, y: 0.8 - phase * 0.5, z: 0 },
                        rightKnee: { x: -0.15 - phase * 0.8, y: 0, z: 0 }
                    };
                } else {
                    // Plant and return to stance
                    const phase = easeInOut((t - 0.7) / 0.3);
                    return {
                        hips: { x: 0, y: 0.1 - phase * 0.05, z: 0 },
                        spine: { x: 0.05 - phase * 0.05, y: 0.1 - phase * 0.1, z: 0 },
                        chest: { x: -0.1 + phase * 0.1, y: 0.05 - phase * 0.15, z: 0 },
                        chestScale: 1,
                        neck: { x: 0, y: 0.05 - phase * 0.05, z: 0 },
                        head: { x: -0.1 + phase * 0.1, y: 0.02 - phase * 0.02, z: 0 },
                        
                        leftShoulder: { x: -0.8 - phase * 0.2, y: -0.3 + phase * 0.3, z: 0.4 },
                        leftElbow: { x: -1.0 - phase * 0.4, y: 0, z: 0 },
                        
                        rightShoulder: { x: -0.8 - phase * 0.2, y: 0.3 - phase * 0.3, z: -0.3 },
                        rightElbow: { x: -1.0 - phase * 0.5, y: 0, z: 0 },
                        
                        leftThigh: { x: 0.1, y: 0, z: 0 },
                        leftKnee: { x: 0.25 - phase * 0.05, y: 0, z: 0 },
                        
                        rightThigh: { x: 1.3 - phase * 1.35, y: 0.3 - phase * 0.3, z: 0 },
                        rightKnee: { x: -0.95 + phase * 1.2, y: 0, z: 0 }
                    };
                }
            }
            
            getBlockPose() {
                // High guard / shell
                return {
                    hips: { x: 0, y: 0, z: 0 },
                    spine: { x: 0.1, y: 0, z: 0 },
                    chest: { x: 0, y: -0.05, z: 0 },
                    chestScale: 0.98,
                    neck: { x: 0.25, y: 0, z: 0 },  // Chin down
                    head: { x: -0.15, y: 0, z: 0 },
                    
                    // Tight guard
                    leftShoulder: { x: -1.6, y: 0, z: 0.5 },
                    leftElbow: { x: -1.8, y: 0, z: 0 },
                    
                    rightShoulder: { x: -1.6, y: 0, z: -0.5 },
                    rightElbow: { x: -1.8, y: 0, z: 0 },
                    
                    // Slight crouch
                    leftThigh: { x: 0.1, y: 0, z: 0 },
                    leftKnee: { x: 0.3, y: 0, z: 0 },
                    rightThigh: { x: -0.05, y: 0, z: 0 },
                    rightKnee: { x: 0.35, y: 0, z: 0 }
                };
            }
        }

        // ===========================
        // THREE.JS SETUP
        // ===========================

        function init() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            // Camera
            camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(0, 3, 10);
            camera.lookAt(0, 2, 0);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const spotLight = new THREE.SpotLight(0xffffff, 1);
            spotLight.position.set(0, 15, 0);
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.width = 2048;
            spotLight.shadow.mapSize.height = 2048;
            scene.add(spotLight);

            const rimLight = new THREE.DirectionalLight(0x4444ff, 0.5);
            rimLight.position.set(5, 5, -5);
            scene.add(rimLight);

            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({
                color: 0x2a2a2a,
                roughness: 0.8,
                metalness: 0.2
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Ring ropes
            const ropeGeometry = new THREE.CylinderGeometry(0.05, 0.05, 12, 16);
            const ropeMaterial = new THREE.MeshStandardMaterial({ color: 0xcc0000 });
            
            for (let i = 0; i < 3; i++) {
                const height = 0.5 + i * 0.5;
                const rope1 = new THREE.Mesh(ropeGeometry, ropeMaterial);
                rope1.rotation.z = Math.PI / 2;
                rope1.position.set(0, height, -6);
                scene.add(rope1);
                
                const rope2 = rope1.clone();
                rope2.position.z = 6;
                scene.add(rope2);
            }

            // Create fighters
            leftFighter = createFighter(0xff4444, -3);
            rightFighter = createFighter(0x4444ff, 3);
            scene.add(leftFighter.group);
            scene.add(rightFighter.group);

            // Button handlers
            document.getElementById('idle-btn').onclick = () => setAnimation('idle');
            document.getElementById('jab-btn').onclick = () => setAnimation('jab');
            document.getElementById('cross-btn').onclick = () => setAnimation('cross');
            document.getElementById('hook-btn').onclick = () => setAnimation('hook');
            document.getElementById('kick-btn').onclick = () => setAnimation('kick');
            document.getElementById('block-btn').onclick = () => setAnimation('block');

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function createFighter(color, xPosition) {
            const fighter = {
                group: new THREE.Group(),
                animator: new RealisticAnimator(),
                bones: {}
            };
            
            fighter.group.position.x = xPosition;

            const bodyMaterial = new THREE.MeshStandardMaterial({
                color: color,
                roughness: 0.7,
                metalness: 0.3
            });

            const darkMaterial = new THREE.MeshStandardMaterial({
                color: new THREE.Color(color).multiplyScalar(0.7),
                roughness: 0.8,
                metalness: 0.2
            });

            // Build skeleton (same as before)
            const hips = new THREE.Group();
            hips.position.y = 1.0;
            fighter.group.add(hips);
            fighter.bones.hips = hips;

            const hipsGeometry = new THREE.BoxGeometry(0.6, 0.3, 0.4);
            const hipsMesh = new THREE.Mesh(hipsGeometry, darkMaterial);
            hipsMesh.castShadow = true;
            hips.add(hipsMesh);

            const spine = new THREE.Group();
            spine.position.y = 0.3;
            hips.add(spine);
            fighter.bones.spine = spine;

            const spineGeometry = new THREE.CylinderGeometry(0.2, 0.25, 0.4, 8);
            const spineMesh = new THREE.Mesh(spineGeometry, bodyMaterial);
            spineMesh.position.y = 0.2;
            spineMesh.castShadow = true;
            spine.add(spineMesh);

            const chest = new THREE.Group();
            chest.position.y = 0.4;
            spine.add(chest);
            fighter.bones.chest = chest;

            const chestGeometry = new THREE.BoxGeometry(0.7, 0.6, 0.4);
            const chestMesh = new THREE.Mesh(chestGeometry, bodyMaterial);
            chestMesh.position.y = 0.3;
            chestMesh.castShadow = true;
            chest.add(chestMesh);
            fighter.bones.chestMesh = chestMesh;

            const neck = new THREE.Group();
            neck.position.y = 0.6;
            chest.add(neck);
            fighter.bones.neck = neck;

            const neckGeometry = new THREE.CylinderGeometry(0.12, 0.15, 0.25, 8);
            const neckMesh = new THREE.Mesh(neckGeometry, bodyMaterial);
            neckMesh.position.y = 0.125;
            neckMesh.castShadow = true;
            neck.add(neckMesh);

            const head = new THREE.Group();
            head.position.y = 0.25;
            neck.add(head);
            fighter.bones.head = head;

            const headGeometry = new THREE.SphereGeometry(0.25, 16, 16);
            const headMesh = new THREE.Mesh(headGeometry, bodyMaterial);
            headMesh.position.y = 0.25;
            headMesh.castShadow = true;
            head.add(headMesh);

            ['left', 'right'].forEach(side => {
                const sign = side === 'left' ? 1 : -1;
                
                const shoulder = new THREE.Group();
                shoulder.position.set(sign * 0.35, 0.5, 0);
                chest.add(shoulder);
                fighter.bones[`${side}Shoulder`] = shoulder;

                const shoulderGeometry = new THREE.SphereGeometry(0.12, 12, 12);
                const shoulderMesh = new THREE.Mesh(shoulderGeometry, bodyMaterial);
                shoulderMesh.castShadow = true;
                shoulder.add(shoulderMesh);

                const upperArm = new THREE.Group();
                upperArm.position.y = -0.15;
                shoulder.add(upperArm);

                const upperArmGeometry = new THREE.CylinderGeometry(0.09, 0.1, 0.35, 8);
                const upperArmMesh = new THREE.Mesh(upperArmGeometry, bodyMaterial);
                upperArmMesh.position.y = -0.175;
                upperArmMesh.castShadow = true;
                upperArm.add(upperArmMesh);

                const elbow = new THREE.Group();
                elbow.position.y = -0.35;
                upperArm.add(elbow);
                fighter.bones[`${side}Elbow`] = elbow;

                const elbowGeometry = new THREE.SphereGeometry(0.09, 10, 10);
                const elbowMesh = new THREE.Mesh(elbowGeometry, bodyMaterial);
                elbowMesh.castShadow = true;
                elbow.add(elbowMesh);

                const forearm = new THREE.Group();
                forearm.position.y = -0.1;
                elbow.add(forearm);

                const forearmGeometry = new THREE.CylinderGeometry(0.075, 0.09, 0.35, 8);
                const forearmMesh = new THREE.Mesh(forearmGeometry, bodyMaterial);
                forearmMesh.position.y = -0.175;
                forearmMesh.castShadow = true;
                forearm.add(forearmMesh);

                const gloveGeometry = new THREE.SphereGeometry(0.12, 12, 12);
                const gloveMesh = new THREE.Mesh(gloveGeometry, darkMaterial);
                gloveMesh.position.y = -0.4;
                gloveMesh.castShadow = true;
                forearm.add(gloveMesh);
            });

            ['left', 'right'].forEach(side => {
                const sign = side === 'left' ? 1 : -1;
                
                const thigh = new THREE.Group();
                thigh.position.set(sign * 0.2, -0.15, 0);
                hips.add(thigh);
                fighter.bones[`${side}Thigh`] = thigh;

                const thighGeometry = new THREE.CylinderGeometry(0.12, 0.14, 0.5, 10);
                const thighMesh = new THREE.Mesh(thighGeometry, bodyMaterial);
                thighMesh.position.y = -0.25;
                thighMesh.castShadow = true;
                thigh.add(thighMesh);

                const knee = new THREE.Group();
                knee.position.y = -0.5;
                thigh.add(knee);
                fighter.bones[`${side}Knee`] = knee;

                const kneeGeometry = new THREE.SphereGeometry(0.11, 12, 12);
                const kneeMesh = new THREE.Mesh(kneeGeometry, bodyMaterial);
                kneeMesh.castShadow = true;
                knee.add(kneeMesh);

                const shin = new THREE.Group();
                shin.position.y = -0.1;
                knee.add(shin);

                const shinGeometry = new THREE.CylinderGeometry(0.09, 0.11, 0.45, 10);
                const shinMesh = new THREE.Mesh(shinGeometry, bodyMaterial);
                shinMesh.position.y = -0.225;
                shinMesh.castShadow = true;
                shin.add(shinMesh);

                const footGeometry = new THREE.BoxGeometry(0.15, 0.1, 0.3);
                const footMesh = new THREE.Mesh(footGeometry, darkMaterial);
                footMesh.position.set(0, -0.5, 0.08);
                footMesh.castShadow = true;
                shin.add(footMesh);
            });

            return fighter;
        }

        function updateFighterAnimation(fighter) {
            fighter.animator.update(0.016);
            const pose = fighter.animator.getPose(fighter);
            
            const bones = fighter.bones;
            
            bones.hips.rotation.set(pose.hips.x, pose.hips.y, pose.hips.z);
            bones.spine.rotation.set(pose.spine.x, pose.spine.y, pose.spine.z);
            bones.chest.rotation.set(pose.chest.x, pose.chest.y, pose.chest.z);
            bones.chestMesh.scale.y = pose.chestScale || 1;
            bones.neck.rotation.set(pose.neck.x, pose.neck.y, pose.neck.z);
            bones.head.rotation.set(pose.head.x, pose.head.y, pose.head.z);
            
            bones.leftShoulder.rotation.set(pose.leftShoulder.x, pose.leftShoulder.y, pose.leftShoulder.z);
            bones.leftElbow.rotation.set(pose.leftElbow.x, pose.leftElbow.y, pose.leftElbow.z);
            bones.rightShoulder.rotation.set(pose.rightShoulder.x, pose.rightShoulder.y, pose.rightShoulder.z);
            bones.rightElbow.rotation.set(pose.rightElbow.x, pose.rightElbow.y, pose.rightElbow.z);
            
            bones.leftThigh.rotation.set(pose.leftThigh.x, pose.leftThigh.y, pose.leftThigh.z);
            bones.leftKnee.rotation.set(pose.leftKnee.x, pose.leftKnee.y, pose.leftKnee.z);
            bones.rightThigh.rotation.set(pose.rightThigh.x, pose.rightThigh.y, pose.rightThigh.z);
            bones.rightKnee.rotation.set(pose.rightKnee.x, pose.rightKnee.y, pose.rightKnee.z);
        }

        function setAnimation(anim) {
            currentAnimation = anim;
            leftFighter.animator.setAnimation(anim);
            rightFighter.animator.setAnimation(anim);
            
            document.querySelectorAll('#controls button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(anim + '-btn').classList.add('active');
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.016;

            updateFighterAnimation(leftFighter);
            updateFighterAnimation(rightFighter);

            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        init();
    </script>
</body>
</html>
